<nav class="bg-emerald-700 shadow-xl z-20 relative">
    <div class="h-16 flex justify-between items-center px-4">

        <a routerLink="/" class="flex items-center space-x-2">
            <span class="text-white text-2xl font-medium tracking-tight cursor-pointer">
                Chatbot โดรนเกษตร
            </span>
        </a>

        <!-- ปุ่มเปิด/ปิดเมนู -->
        <button (click)="toggleMobileMenu()" 
            class="text-white md:hidden p-2 transition focus:outline-none z-30">
            <svg class="w-6 h-6 transition-transform duration-300" [ngClass]="{ 'rotate-180': isMenuOpen }"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4.5 5.25l7.5 7.5 7.5-7.5m-15 6l7.5 7.5 7.5-7.5" />
            </svg>
        </button>

        <!-- ปุ่ม login/register บนจอใหญ่ (แสดงเมื่อยังไม่ได้ login) -->
        @if (!isLoggedIn) {
        <div class="hidden md:flex items-center space-x-4">
            <a routerLink="/login"
                class="text-white font-semibold py-2 px-4 rounded-full border-2 border-emerald-500 hover:bg-emerald-600 transition duration-300">
                เข้าสู่ระบบ
            </a>
            <a routerLink="/register"
                class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-300">
                สมัครสมาชิก
            </a>
        </div>
        }
    </div>
</nav>

<!-- Overlay -->
@if (isMenuOpen) {
<div (click)="toggleMobileMenu()"
    class="md:hidden fixed inset-0 bg-black opacity-10 z-10 transition-opacity duration-300 ease-in-out">
</div>
}

<!-- เมนูขยาย -->
<div class="md:hidden fixed top-16 left-0 w-full h-[calc(100vh-4rem)] bg-emerald-600 z-20 shadow-lg transition-all duration-300 ease-in-out overflow-hidden"
    [ngClass]="{
    'max-h-0 opacity-0': !isMenuOpen,
    'max-h-[calc(100vh-4rem)] opacity-100': isMenuOpen
  }">
    
    <div class="flex flex-col h-full px-4 py-3">
        
        <!-- ปุ่มแชทใหม่ (แสดงทั้ง guest และ login) -->
        <button type="button" (click)="onNewChat()"
            class="flex items-center w-full px-3 py-2 mb-2 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-emerald-500 text-white shrink-0">
            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            <span>แชทใหม่</span>
        </button>

        @if (isLoggedIn) {
        <!-- รายการแชท (แสดงเฉพาะตอน login) -->
        <div class="flex-1 overflow-y-auto space-y-1 mb-2 min-h-0 pr-2 custom-scrollbar">
            @for (convo of conversations; track convo.conversationId) {
            <div (click)="onSelectConversation(convo.conversationId)"
                [class.bg-emerald-500]="selectedConversationId === convo.conversationId"
                class="flex items-center justify-between px-3 py-2 text-sm text-emerald-100 rounded-lg transition-colors duration-200 hover:bg-emerald-500 cursor-pointer group">
                <span class="flex-1 truncate" [title]="convo.lastMessage">
                    {{ convo.lastMessage.length > 30 ? convo.lastMessage.substring(0, 30) + '...' : convo.lastMessage || 'แชทใหม่' }}
                </span>

                <button (click)="onDeleteConversation($event, convo.conversationId)"
                    class="opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500 ml-2 shrink-0 p-1 transition-opacity duration-200"
                    title="ลบการสนทนา">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="m14.74 9-.346 9m-4.788 0L9.26 9M4.78 5.862l1.06 13.811a2.25 2.25 0 002.244 2.077h7.832a2.25 2.25 0 002.244-2.077l1.06-13.811M9 7.5V5.25m6 2.25V5.25m-9 2.25h12.75" />
                    </svg>
                </button>
            </div>
            } @empty {
            <p class="px-3 py-2 text-sm text-emerald-300">
                ยังไม่มีประวัติแชท
            </p>
            }
        </div>

        <!-- ปุ่มออกจากระบบ (แสดงเฉพาะตอน login) -->
        <button (click)="onSignOut()" type="button"
            class="flex items-center w-full px-3 py-2 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-emerald-500 text-white border-t border-emerald-500 pt-3 mt-2 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-5 h-5 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
            </svg>
            <span>ออกจากระบบ</span>
        </button>
        
        } @else {
        <!-- ปุ่ม login/register (แสดงเฉพาะตอนยังไม่ได้ login) -->
        <div class="flex flex-col space-y-2 shrink-0">
            <a routerLink="/login" (click)="toggleMobileMenu()"
                class="text-white font-semibold py-2 px-4 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-center transition duration-300">
                เข้าสู่ระบบ
            </a>
            <a routerLink="/register" (click)="toggleMobileMenu()"
                class="text-white font-semibold py-2 px-4 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-center transition duration-300">
                สมัครสมาชิก
            </a>
        </div>
        }
    </div>
</div>